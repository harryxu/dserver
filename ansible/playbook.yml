---
- hosts: all
  sudo: yes
  vars:
    timezone: Asia/Shanghai

    # Apache vars
    apache_remove_default_vhost: true
    apache_create_vhosts: true
    apache_vhosts:
    - servername: "default_vhost"
      documentroot: "/data/www"
      extra_parameters: |
        <Directory "/data/www">
          Options Indexes FollowSymLinks MultiViews
          AllowOverride All
          Require all granted
        </Directory>
        <FilesMatch "\.php$">
          SetHandler "proxy:fcgi://127.0.0.1:9000"
        </FilesMatch>

    # PHP vars
    php_enable_webserver: true
    php_webserver_daemon: "apache2"
    php_enable_php_fpm: true
    php_fpm_listen: "127.0.0.1:9000"
    php_fpm_listen_allowed_clients: "127.0.0.1"
    php_conf_paths:
      - /etc/php/7.1/fpm
      - /etc/php/7.1/apache2
      - /etc/php/7.1/cli

    php_extension_conf_paths:
      - /etc/php/7.1/fpm/conf.d
      - /etc/php/7.1/apache2/conf.d
      - /etc/php/7.1/cli/conf.d

    php_fpm_daemon: php7.1-fpm
    php_fpm_conf_path: "/etc/php/7.1/fpm"
    php_fpm_pool_conf_path: "/etc/php/7.1/fpm/pool.d/www.conf"

    php_packages:
      - php7.1-fpm
      - php7.1-common
      - php7.1-cli
      - php7.1-dev
      - php7.1-gd
      - php7.1-curl
      - php7.1-imap
      - php7.1-json
      - php7.1-xml
      - php7.1-mbstring
      - php7.1-sqlite3
      - php7.1-mcrypt
      - php7.1-mysql
      - php7.1-pdo
      - php7.1-opcache
      - php-apcu
      - php7.1-sybase
      - php7.1-zip

    php_pecl_extensions:
      - sqlsrv
      - pdo_sqlsrv

    # MySQL vars
    mysql_root_username: root
    mysql_root_password: '1'
    mysql_root_password_update: yes
    mysql_bind_address: '0.0.0.0'
    mysql_config_include_files:
      - src: /vagrant/files/mysql.cnf
        force: true
    mysql_users:
      - name: sa
        host: '%'
        password: '1'
        priv: "*.*:ALL"

    # Nodejs
    nodejs_version: '6.x'

  pre_tasks:
    - apt_repository:
        repo: 'ppa:ondrej/php'

    - apt_repository:
        repo: 'ppa:ondrej/apache2'

    - apt_repository:
        repo: 'ppa:git-core/ppa'

    # Microsoft ODBC Driver
    - apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present
    - apt_repository:
        repo: deb [arch=amd64] https://packages.microsoft.com/ubuntu/16.04/prod xenial main
        state: present
    - name: Install mssql packages
      apt: name={{ item }} state=present
      with_items:
        - msodbcsql=13.0.1.0-1
        - mssql-tools=14.0.2.0-1
        - unixodbc-dev-utf16
      environment:
        ACCEPT_EULA: Y

  tasks:
    - name: Install required softwares
      apt: name={{ item }} state=present
      with_items:
        - git
        - vim
        - tmux
        - autojump

    - stat:
        path: /home/vagrant/.vimrc
      register: vimrc

    - name: Copy vimrc
      command: cp /vagrant/files/vimrc /home/vagrant/.vimrc
      become: yes
      become_user: vagrant
      when: vimrc.stat.exists == False

  roles:
    - geerlingguy.apache
    - geerlingguy.php
    - geerlingguy.php-pecl
    - geerlingguy.apache-php-fpm
    - geerlingguy.composer
    - geerlingguy.mysql
    - angstwad.docker_ubuntu
    - yatesr.timezone

    - role: gantsign.oh-my-zsh
      users:
        - username: vagrant
          oh_my_zsh:
            theme: ""
            plugins:
              - git
              - autojump

    - geerlingguy.nodejs

  post_tasks:
    - apt_key:
        url: "https://dl.yarnpkg.com/debian/pubkey.gpg"
        state: present

    - apt_repository:
        repo: deb https://dl.yarnpkg.com/debian/ stable main
        state: present
        filename: 'yarn.list'

    - name: Install required softwares in post tasks
      apt: name={{ item }} state=present
      with_items:
        - yarn

    - file:
        src: /vagrant/ansible/files/20-sqlsrv.ini
        dest: '{{ php_fpm_conf_path }}/conf.d/20-sqlsrv.ini'
        state: link

    - include: tasks/pure-prompt.yml
    - include: tasks/tmux-conf.yml
